<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Error_on_Moment_Journey_Match</name>
        <label>Error on Moment/Journey Match</label>
        <locationX>909</locationX>
        <locationY>1343</locationY>
        <actionName>emailSimple</actionName>
        <actionType>emailSimple</actionType>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>emailAddresses</name>
            <value>
                <stringValue>seanh@retool.com, adam.louie@retool.com</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailSubject</name>
            <value>
                <stringValue>SFDC: Error on Matching Moment to Journey</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailBody</name>
            <value>
                <stringValue>There is an error on Moment mapping into a Journey. ID = {!$Record.Id}. Link: https://retool.lightning.force.com/lightning/r/Moment__c/{!$Record.Id}/view</stringValue>
            </value>
        </inputParameters>
        <nameSegment>emailSimple</nameSegment>
        <offset>0</offset>
    </actionCalls>
    <actionCalls>
        <name>Send_Demo_Request_Alert</name>
        <label>Send Demo Request Alert</label>
        <locationX>1110</locationX>
        <locationY>357</locationY>
        <actionName>emailSimple</actionName>
        <actionType>emailSimple</actionType>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>emailAddresses</name>
            <value>
                <elementReference>$Record.Journey__r.Owner__r.Email</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailSubject</name>
            <value>
                <stringValue>New Moment Reopened Journey: {!$Record.Contact__r.Current_Open_Journey__r.Name}</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailBody</name>
            <value>
                <elementReference>New_Moment_Alert_Email</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>ccRecipientAddressList</name>
            <value>
                <stringValue>adam.louie@retool.com</stringValue>
            </value>
        </inputParameters>
        <nameSegment>emailSimple</nameSegment>
        <offset>0</offset>
    </actionCalls>
    <apiVersion>58.0</apiVersion>
    <assignments>
        <name>JourneyID_from_Contact</name>
        <label>JourneyID from Contact</label>
        <locationX>493</locationX>
        <locationY>948</locationY>
        <assignmentItems>
            <assignToReference>JourneyID</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.Contact__r.Current_Open_Journey__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Moment_w_Journey</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>JourneyID_from_Create</name>
        <label>JourneyID from Create</label>
        <locationX>490</locationX>
        <locationY>801</locationY>
        <assignmentItems>
            <assignToReference>JourneyID</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Create_Journey</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Moment_w_Journey</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>JourneyID_from_Create_Regie</name>
        <label>JourneyID from Create</label>
        <locationX>328</locationX>
        <locationY>642</locationY>
        <assignmentItems>
            <assignToReference>JourneyID</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Create_Regie_ai_Journey</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_Moment_w_Journey</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>CheckMQL</name>
        <label>CheckMQL ?</label>
        <locationX>1324</locationX>
        <locationY>642</locationY>
        <defaultConnector>
            <targetReference>Make_a_Journey</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No Check MQL</defaultConnectorLabel>
        <rules>
            <name>Check_MQL_is_True</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Check_MQL__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Launch_Check_MQL</targetReference>
            </connector>
            <label>Check MQL is True</label>
        </rules>
    </decisions>
    <decisions>
        <name>Journey_Cases</name>
        <label>Journey Cases</label>
        <locationX>901</locationX>
        <locationY>811</locationY>
        <defaultConnector>
            <targetReference>Update_Moment_with_Journey_Error</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Journey Node Default</defaultConnectorLabel>
        <rules>
            <name>Journey_from_CP</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Contact__r.Current_Open_Journey__r.Create_Method__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>CP Meeting Booked</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_Existing_Journey</targetReference>
            </connector>
            <label>Journey from CP</label>
        </rules>
        <rules>
            <name>Regie_ai</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Moment_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Regie.ai - Conversion</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Contact__r.Current_Open_Journey__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Regie_Started_Moment</targetReference>
            </connector>
            <label>Regie.ai</label>
        </rules>
        <rules>
            <name>No_Journey</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Contact__r.Current_Open_Journey__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Create_Journey</targetReference>
            </connector>
            <label>No Journey</label>
        </rules>
    </decisions>
    <decisions>
        <name>Make_a_Journey</name>
        <label>Make a Journey?</label>
        <locationX>1101</locationX>
        <locationY>812</locationY>
        <defaultConnectorLabel>No Journey Needed</defaultConnectorLabel>
        <rules>
            <name>Reopen_Resting_Journey</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Journey__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Journey__r.Is_Resting__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Journey__r.Rest_Until__c</leftValueReference>
                <operator>GreaterThan</operator>
                <rightValue>
                    <elementReference>$Flow.CurrentDate</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Moment_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Demo Request</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Journey__r.Stage__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>Converted</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Moment_Date__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <elementReference>$Flow.CurrentDate</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Journey__r.Stage__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>Rejected</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_Resting_Journey</targetReference>
            </connector>
            <label>Reopen Resting Journey</label>
        </rules>
        <rules>
            <name>Journey_Needed</name>
            <conditionLogic>1 AND 2 AND (3 OR 6 OR 7 OR 8 OR 9 OR 10 OR 11) AND 4 AND 5</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Moment_Date__c</leftValueReference>
                <operator>GreaterThanOrEqualTo</operator>
                <rightValue>
                    <elementReference>WeeksAgo2</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Journey__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Is_MQL__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Ops_Notes__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>JourneyError</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Contact__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Moment_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Demo Request</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.MQL_Check_Results__c</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <stringValue>but Moment Type Not Eligible</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.MQL_Check_Results__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>MQL Filter Criteria Flagged: C9CurrentOpenJourney</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Moment_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Support</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Moment_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Champify Alert</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Moment_Type__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Regie.ai - Conversion</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Journey_Cases</targetReference>
            </connector>
            <label>Journey Needed</label>
        </rules>
    </decisions>
    <description>Adding nodes to reopen resting Journeys if a Demo Request Moment is created.
Excluding &#39;Rejected&#39; Journeys from being reopened.</description>
    <environments>Default</environments>
    <formulas>
        <name>WeeksAgo2</name>
        <dataType>Date</dataType>
        <expression>TODAY() - 14</expression>
    </formulas>
    <interviewLabel>Moment - After Save Automations {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Moment: After Save Automations</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordCreates>
        <name>Create_Journey</name>
        <label>Create Journey</label>
        <locationX>661</locationX>
        <locationY>801</locationY>
        <connector>
            <targetReference>JourneyID_from_Create</targetReference>
        </connector>
        <inputAssignments>
            <field>Contact__c</field>
            <value>
                <elementReference>$Record.Contact__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Create_Method__c</field>
            <value>
                <stringValue>Moment</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Created_From_Moment__c</field>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Identified_At__c</field>
            <value>
                <elementReference>$Flow.CurrentDateTime</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Name</field>
            <value>
                <stringValue>Journey from Moment</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Stage__c</field>
            <value>
                <stringValue>Identified</stringValue>
            </value>
        </inputAssignments>
        <object>Journey__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordCreates>
        <name>Create_Regie_ai_Journey</name>
        <label>Create Regie.ai Journey</label>
        <locationX>497</locationX>
        <locationY>642</locationY>
        <connector>
            <targetReference>JourneyID_from_Create_Regie</targetReference>
        </connector>
        <inputAssignments>
            <field>Contact__c</field>
            <value>
                <elementReference>$Record.Contact__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Create_Method__c</field>
            <value>
                <stringValue>Moment</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Created_From_Moment__c</field>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Engaged_At__c</field>
            <value>
                <elementReference>$Record.Moment_Occurred_At__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Identified_At__c</field>
            <value>
                <elementReference>Get_Regie_Started_Moment.Moment_Occurred_At__c</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Name</field>
            <value>
                <stringValue>Journey from Moment</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Stage__c</field>
            <value>
                <stringValue>Engaged</stringValue>
            </value>
        </inputAssignments>
        <object>Journey__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordCreates>
    <recordLookups>
        <name>Get_Regie_Started_Moment</name>
        <label>Get Regie Started Moment</label>
        <locationX>658</locationX>
        <locationY>642</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Create_Regie_ai_Journey</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Contact__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Contact__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Moment_Occurred_At__c</field>
            <operator>LessThan</operator>
            <value>
                <elementReference>$Record.Moment_Occurred_At__c</elementReference>
            </value>
        </filters>
        <filters>
            <field>Moment_Type__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Regie.ai - Started</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Moment__c</object>
        <sortField>Moment_Occurred_At__c</sortField>
        <sortOrder>Desc</sortOrder>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_Existing_Journey</name>
        <label>Update Existing Journey</label>
        <locationX>659</locationX>
        <locationY>948</locationY>
        <connector>
            <targetReference>JourneyID_from_Contact</targetReference>
        </connector>
        <inputAssignments>
            <field>Create_Method__c</field>
            <value>
                <stringValue>Moment</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Created_From_Moment__c</field>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record.Contact__r.Current_Open_Journey__r</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Moment_w_Journey</name>
        <label>Update Moment /w Journey</label>
        <locationX>50</locationX>
        <locationY>801</locationY>
        <inputAssignments>
            <field>Journey_Relationship__c</field>
            <value>
                <stringValue>Created</stringValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Journey__c</field>
            <value>
                <elementReference>JourneyID</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Moment_with_Journey_Error</name>
        <label>Update Moment with Journey Error</label>
        <locationX>911</locationX>
        <locationY>1142</locationY>
        <connector>
            <targetReference>Error_on_Moment_Journey_Match</targetReference>
        </connector>
        <inputAssignments>
            <field>Ops_Notes__c</field>
            <value>
                <stringValue>JourneyError</stringValue>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_Resting_Journey</name>
        <label>Update Resting Journey</label>
        <locationX>1110</locationX>
        <locationY>542</locationY>
        <connector>
            <targetReference>Send_Demo_Request_Alert</targetReference>
        </connector>
        <inputAssignments>
            <field>Closed_At__c</field>
        </inputAssignments>
        <inputAssignments>
            <field>Ended_Reason_Details__c</field>
        </inputAssignments>
        <inputAssignments>
            <field>Ended_Reason__c</field>
        </inputAssignments>
        <inputAssignments>
            <field>Is_Closed__c</field>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Is_Resting__c</field>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Journey_Which_Triggered_End__c</field>
        </inputAssignments>
        <inputAssignments>
            <field>Re_engage_Post_Rest__c</field>
            <value>
                <booleanValue>false</booleanValue>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Rejected_Reason__c</field>
        </inputAssignments>
        <inputAssignments>
            <field>Rest_For_Days__c</field>
        </inputAssignments>
        <inputAssignments>
            <field>Rest_Until__c</field>
        </inputAssignments>
        <inputAssignments>
            <field>Resting_At__c</field>
        </inputAssignments>
        <inputAssignments>
            <field>Stage__c</field>
            <value>
                <stringValue>Engaged</stringValue>
            </value>
        </inputAssignments>
        <inputReference>$Record.Contact__r.Current_Open_Journey__r</inputReference>
    </recordUpdates>
    <start>
        <locationX>1205</locationX>
        <locationY>48</locationY>
        <connector>
            <targetReference>CheckMQL</targetReference>
        </connector>
        <object>Moment__c</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <subflows>
        <name>Launch_Check_MQL</name>
        <label>Launch Check MQL</label>
        <locationX>1332</locationX>
        <locationY>947</locationY>
        <connector>
            <targetReference>Make_a_Journey</targetReference>
        </connector>
        <flowName>DRAFT_Autolaunch_Check_MQL</flowName>
        <inputAssignments>
            <name>TriggeringMoment</name>
            <value>
                <elementReference>$Record</elementReference>
            </value>
        </inputAssignments>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </subflows>
    <textTemplates>
        <name>New_Moment_Alert_Email</name>
        <isViewedAsPlainText>true</isViewedAsPlainText>
        <text>Journey: {!$Record.Contact__r.Current_Open_Journey__r.Name}
https://retool.lightning.force.com/lightning/r/Journey__c/{!$Record.Contact__r.Current_Open_Journey__c}/view

Moment: {!$Record.Name}
https://retool.lightning.force.com/lightning/r/Moment__c/{!$Record.Id}/view

Date: {!$Record.Moment_Date__c}
Type: {!$Record.Moment_Type__c} - {!$Record.Moment_Type_Reporting__c}
Description: {!$Record.Moment_Description__c}
Context: {!$Record.Moment_Context__c}</text>
    </textTemplates>
    <variables>
        <name>JourneyID</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
